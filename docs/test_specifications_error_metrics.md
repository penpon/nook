# テスト仕様書: error_metrics.py

## 対象モジュール
- ファイル: nook/common/error_metrics.py
- 現在のカバレッジ: 0%
- 目標カバレッジ: 95%以上

## テスト対象の関数/クラス一覧

### 1. ErrorMetrics クラス
- エラーメトリクスの収集と集約
- タイムウィンドウによる古いエラーの自動削除
- エラー統計の生成とレポート作成

### 2. error_metrics グローバルインスタンス
- デフォルトの60分ウィンドウ

## テスト観点

### ErrorMetrics.__init__

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| デフォルトウィンドウ | window_minutes=60 | 60分ウィンドウ | - |
| カスタムウィンドウ | window_minutes=30 | 30分ウィンドウ | - |
| 空の初期状態 | 初期化直後 | errors=空のdict | - |

#### 境界値
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 最小ウィンドウ | window_minutes=1 | 1分ウィンドウ | - |
| 大きなウィンドウ | window_minutes=1440 | 24時間ウィンドウ | - |

### ErrorMetrics.record_error

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 初回エラー記録 | error_type="ValueError", details={} | エラーが記録される | - |
| 同一タイプ複数記録 | 同じerror_typeを複数回 | リストに追加される | - |
| 異なるタイプ記録 | 複数のerror_type | 各タイプで管理される | - |
| detailsに情報含む | details={"msg": "test"} | detailsが保存される | - |

#### 異常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 古いエラー削除 | ウィンドウ外のエラー | 自動削除される | - |
| ウィンドウ境界 | ちょうどウィンドウ時間前 | 削除される | cutoff判定 |

#### 境界値
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| ちょうどウィンドウ内 | cutoff時刻より1秒後 | 保持される | - |
| ちょうどウィンドウ外 | cutoff時刻と同じ | 削除される | - |

#### スレッドセーフ
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 並行書き込み | 複数スレッドから記録 | データ競合なし | lock使用確認 |

### ErrorMetrics.get_error_stats

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| エラーあり | 複数エラー記録済み | 統計dictを返す | count, first, last, rate含む |
| エラーなし | 記録なし | 空のdict | - |
| 複数タイプ | 異なるタイプのエラー | 各タイプの統計 | - |

#### 異常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 古いエラーのみ | ウィンドウ外エラーのみ | 空のdict | - |
| ウィンドウ境界 | cutoffちょうどのエラー | 統計に含まれない | - |

#### 統計値検証
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| count計算 | N個のエラー | count=N | - |
| rate計算 | 60分で60エラー | rate_per_minute=1.0 | - |
| first_occurrence | 複数エラー | 最初のタイムスタンプ | ISO形式 |
| last_occurrence | 複数エラー | 最後のタイムスタンプ | ISO形式 |

#### スレッドセーフ
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 並行読み込み | 複数スレッドから取得 | 一貫性のあるデータ | lock使用確認 |

### ErrorMetrics.get_error_report

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| エラーあり | 統計データあり | フォーマット済みレポート文字列 | - |
| エラーなし | 統計データなし | "No errors in the last N minutes" | - |
| 複数タイプ | 複数のエラータイプ | count降順でソート | - |

#### レポート内容検証
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| ヘッダー行 | 任意のデータ | "Error Report (last N minutes)" | - |
| セパレータ | 任意のデータ | "="*50 | - |
| Error Type表示 | error_type="ValueError" | "Error Type: ValueError" | - |
| Count表示 | count=10 | "Count: 10" | - |
| Rate表示 | rate=2.5 | "Rate: 2.50 errors/minute" | 小数点2桁 |
| First/Last表示 | ISO形式タイムスタンプ | "First: ...", "Last: ..." | - |

#### ソート順
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| count降順 | 複数タイプ | count多い順に表示 | - |

### グローバルインスタンス

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| error_metrics存在 | import時 | ErrorMetricsインスタンス | - |
| デフォルト設定 | グローバルインスタンス | window_minutes=60 | - |

## カバレッジ目標
- 分岐網羅率: 95%以上
- 境界値テスト: 全て実施
- 異常系テスト: 正常系以上の数
- スレッドセーフティの確認
- 時間依存処理のモック化
- タイムウィンドウ境界のテスト
