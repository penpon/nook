# テスト仕様書: rate_limiter.py

## 対象モジュール
- ファイル: nook/common/rate_limiter.py
- 現在のカバレッジ: 0%
- 目標カバレッジ: 95%以上

## テスト対象の関数/クラス一覧

### 1. RateLimiter クラス
- トークンバケットアルゴリズムによるレート制限実装
- 非同期acquireメソッドでレート制限を適用

### 2. RateLimitedHTTPClient クラス
- AsyncHTTPClientを継承したレート制限付きHTTPクライアント
- ドメインごとの個別レート制限設定

## テスト観点

### RateLimiter.__init__

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| デフォルトパラメータ | rate=10 | burst=10, allowance=10.0 | burstはrateと同じ |
| burstを明示指定 | rate=10, burst=20 | burst=20, allowance=20.0 | burstが優先 |
| per指定 | rate=60, per=timedelta(minutes=1) | 60req/分の制限 | - |

#### 境界値
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 最小レート | rate=1 | 正常に初期化 | - |
| 大きなレート | rate=1000 | 正常に初期化 | - |

### RateLimiter.acquire

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 十分なトークンあり | tokens=1, allowance=10 | 即座に返る | 待機なし |
| トークン回復後に取得 | 複数回呼び出し | 時間経過でトークン回復 | - |

#### 異常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| トークン不足 | tokens=10, allowance=5 | 待機してからトークン取得 | sleep発生 |
| レート超過連続呼び出し | rate=1, 連続10回 | 各呼び出しで待機 | - |

#### 境界値
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| ちょうどallowance分 | tokens=allowance | 即座に返る | - |
| allowance+1 | tokens=allowance+1 | 待機発生 | - |
| トークン0個取得 | tokens=0 | 即座に返る | エッジケース |

### RateLimitedHTTPClient.__init__

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| デフォルト | config=None | default_rate_limit=60/分 | - |
| カスタムレート制限 | default_rate_limit指定 | カスタム値が設定される | - |

### RateLimitedHTTPClient.add_domain_rate_limit

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 新規ドメイン追加 | domain="example.com", rate=10 | domain_rate_limitsに追加 | - |
| 既存ドメイン上書き | 同一ドメインを2回追加 | 新しい設定で上書き | - |

### RateLimitedHTTPClient._get_domain

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| http URL | "http://example.com/path" | "example.com" | - |
| https URL | "https://example.com/path" | "example.com" | - |
| ポート付きURL | "https://example.com:8080/path" | "example.com:8080" | - |

#### 異常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 不正なURL | "invalid-url" | 空文字列またはエラー | - |

### RateLimitedHTTPClient.get/post

#### 正常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| デフォルトレート制限 | 未登録ドメインへのリクエスト | default_rate_limitが適用される | - |
| ドメイン別レート制限 | 登録済みドメインへのリクエスト | ドメイン専用レート制限が適用 | - |
| 連続リクエスト | 同一ドメインへ複数回 | レート制限が順守される | - |

#### 異常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| レート超過 | 短時間に大量リクエスト | 適切に待機してリクエスト実行 | - |

## カバレッジ目標
- 分岐網羅率: 95%以上
- 境界値テスト: 全て実施
- 異常系テスト: 正常系以上の数
- 非同期処理の適切なテスト
- 時間依存処理のモック化
