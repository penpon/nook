# テスト仕様書: daily_merge.py

## 対象モジュール
- ファイル: nook/common/daily_merge.py
- 現在のカバレッジ: 55%
- 目標カバレッジ: 95%以上

## テスト対象の関数/クラス一覧

### 1. merge_records 関数
- 既存データと新規データのマージ
- 重複排除（keyによる識別）
- ソート・制限機能

### 2. merge_grouped_records 関数
- グループ別レコードマージ
- 既存グループの引き継ぎ

## テスト観点

### merge_records

#### 正常系（基本動作）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 新規データのみ | existing=[], incoming=[1,2,3] | [1,2,3] | - |
| 既存データのみ | existing=[1,2,3], incoming=[] | [1,2,3] | - |
| 重複なしマージ | 異なるキーのデータ | 全データ含む | - |
| 重複ありマージ | 同一キーあり | 新規データで上書き | - |

#### 正常系（ソート）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| sort_key=None | ソートキー未指定 | 挿入順（既存→新規） | - |
| sort_key指定 | sort_key=lambda x: x | ソート済み | - |
| reverse=True | 降順ソート | 降順で返る | デフォルト |
| reverse=False | 昇順ソート | 昇順で返る | - |

#### 正常系（制限）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| limit=None | 制限なし | 全データ返る | デフォルト |
| limit=10 | 10件制限 | 最大10件 | - |
| limit > データ数 | 制限が大きい | 全データ返る | - |

#### 異常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 空のイテラブル | [], [] | [] | - |

#### 境界値
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| limit=0 | 0件制限 | [] | - |
| limit=1 | 1件制限 | 1件のみ | - |
| ちょうどlimit件 | データ数=limit | limit件返る | - |
| limit+1件 | データ数=limit+1 | limit件返る | 1件切り捨て |

#### 重複処理
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 全て重複 | existing=incoming | incomingのデータ | 上書き |
| 部分重複 | 一部同一キー | 新規で上書き、他は追加 | - |
| 既存内で重複 | existing内に重複キー | 最後のものが保持 | OrderedDict動作 |

#### データ型
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| dict型 | dict要素 | 正常動作 | - |
| カスタムクラス | カスタムオブジェクト | 正常動作 | - |
| 文字列 | 文字列リスト | key関数次第 | - |

#### key関数
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| lambda x: x["id"] | dictのid | id重複排除 | - |
| lambda x: x | 値そのもの | 値重複排除 | - |
| 複雑なkey | タプル返す関数 | 正常動作 | - |

#### sort_key関数
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| lambda x: x["date"] | dictのdate | dateでソート | - |
| lambda x: -x | 数値逆順 | 逆順ソート | - |

### merge_grouped_records

#### 正常系（基本動作）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 新規グループのみ | existing=None, incoming={} | incoming返る | - |
| existing=None | None指定 | 空dictとして扱う | - |
| existing={} | 空dict | incomingのみ | - |
| 重複なしグループ | 異なるグループ | 全グループ含む | - |

#### 正常系（グループマージ）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 同一グループ更新 | 同じグループキー | merge_recordsでマージ | - |
| 既存グループ引き継ぎ | incomingにないグループ | existingのまま保持 | - |
| 新規グループ追加 | 新しいグループキー | 追加される | - |

#### 正常系（パラメータ伝播）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| key引数 | key関数 | 各グループでkey使用 | - |
| sort_key引数 | sort_key関数 | 各グループでソート | - |
| limit_per_group | limit指定 | 各グループで制限 | - |
| reverse引数 | reverse=False | 各グループで昇順 | - |

#### 異常系
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 空グループ | incoming={"group": []} | 空リスト保持 | - |

#### 境界値
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| limit_per_group=0 | 0件制限 | 各グループ0件 | - |
| limit_per_group=None | 制限なし | 全データ | デフォルト |

#### グループ引き継ぎ
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 既存のみのグループ | incomingにない | そのまま引き継ぐ | list()でコピー |
| 全グループ更新 | 全グループincomingにあり | 既存は参照されない | - |

#### データ型
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| Sequence型 | list, tuple | 正常動作 | - |
| dict値 | dict要素のSequence | 正常動作 | - |

#### 複数グループ同時処理
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 3グループ | existing: A,B / incoming: B,C | A,B,C全て含む | - |
| 10グループ | 大量グループ | 全て処理 | - |

## カバレッジ目標
- 分岐網羅率: 95%以上
- 境界値テスト: 全て実施
- 異常系テスト: 正常系以上の数
- 重複排除ロジックの確認
- ソート機能の検証
- OrderedDictの動作確認
- グループ引き継ぎ確認
