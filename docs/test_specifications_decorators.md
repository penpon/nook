# テスト仕様書: decorators.py

## 対象モジュール
- ファイル: nook/common/decorators.py
- 現在のカバレッジ: 47.06%
- 目標カバレッジ: 95%以上

## テスト対象の関数/クラス一覧

### 1. handle_errors デコレータ
- リトライ機能付きエラーハンドリング
- 非同期・同期両対応
- 指数バックオフによる待機

### 2. log_execution_time デコレータ
- 実行時間のログ記録
- 非同期関数のみ対応（同期版は未実装）

## テスト観点

### handle_errors デコレータ

#### 正常系（非同期）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 1回目で成功 | 正常な非同期関数 | 関数結果を返す | リトライなし |
| 2回目で成功 | 1回失敗後に成功する関数 | 関数結果を返す | リトライ1回 |
| デフォルトパラメータ | retries=3, delay=1.0, backoff=2.0 | 正しく動作 | - |

#### 正常系（同期）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 1回目で成功 | 正常な同期関数 | 関数結果を返す | リトライなし |
| 2回目で成功 | 1回失敗後に成功する関数 | 関数結果を返す | リトライ1回 |

#### 異常系（非同期）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 全リトライ失敗 | retries=3で全て失敗 | RetryException発生 | from句で元の例外 |
| 初回から例外 | 常に例外を出す関数 | RetryException発生 | - |
| ValueError発生 | 特定例外発生 | RetryExceptionでラップ | - |
| RuntimeError発生 | 特定例外発生 | RetryExceptionでラップ | - |

#### 異常系（同期）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 全リトライ失敗 | retries=3で全て失敗 | RetryException発生 | - |
| 長いエラーメッセージ | 100文字超エラー | メッセージは100文字に切り詰め | ログ出力確認 |

#### 境界値
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| retries=1 | 1回のみリトライ | 1回失敗で例外 | - |
| retries=10 | 10回リトライ | 最大10回試行 | - |
| delay=0 | 待機なし | 即座にリトライ | - |
| backoff=1.0 | 固定待機時間 | delay固定 | - |
| backoff=10.0 | 急激な増加 | 待機時間が指数的に増加 | - |

#### 動作確認
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| ログ出力（成功） | リトライ後に成功 | infoログ出力 | "succeeded after N retries" |
| ログ出力（失敗） | 各リトライで失敗 | warningログ出力 | 試行回数含む |
| ログ出力（最終失敗） | 全失敗 | errorログ出力 | "failed after N attempts" |
| wait_time計算 | delay=1, backoff=2 | 1, 2, 4秒待機 | 指数バックオフ |

### log_execution_time デコレータ

#### 正常系（非同期）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 正常な関数 | 非同期関数 | 関数結果を返す | 実行時間ログ出力 |
| 処理時間測定 | sleep含む関数 | 適切な実行時間記録 | - |

#### 異常系（非同期）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 例外発生 | 例外を投げる関数 | 例外を再raise | errorログ出力 |
| 例外時の時間測定 | 例外発生まで時間計測 | execution_timeログ記録 | - |

#### 正常系（同期）
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 同期関数 | 同期関数 | 元の関数をそのまま返す | ログなし（未実装） |

#### ログ確認
| テストケース | 入力 | 期待する出力 | 備考 |
|------------|------|-------------|------|
| 成功時ログ | 正常終了 | infoログに"completed" | extra含む |
| 失敗時ログ | 例外発生 | errorログに"failed" | extra含む |
| execution_timeフィールド | 任意の関数 | float型の実行時間 | 秒単位 |

## カバレッジ目標
- 分岐網羅率: 95%以上
- 境界値テスト: 全て実施
- 異常系テスト: 正常系以上の数
- 同期・非同期両パターンのテスト
- ログ出力の検証
- 待機時間の検証（モック使用）
