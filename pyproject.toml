[project]
name = "nook"
version = "0.1.0"
description = "AI-powered content aggregation platform"
readme = "README.md"
requires-python = ">=3.10"
dependencies = [
    "fastapi>=0.95.0",
    "uvicorn>=0.21.1",
    "httpx[http2]>=0.24.0",
    "cloudscraper>=1.2.71",
    "requests>=2.28.2",
    "pandas>=2.3.3",
    "pydantic>=2.0.0",
    "pydantic-settings>=2.0.0",
    "python-dotenv>=1.0.0",
    "arxiv>=1.4.7",
    "pdfplumber>=0.10.0",
    "beautifulsoup4>=4.12.0",
    "openai>=1.0.0",
    "tiktoken>=0.5.0",
    "tenacity>=8.0.0",
    "aiofiles>=23.0.0",
    "feedparser>=6.0.10",
    "asyncpraw>=7.7.1",
    "python-dateutil>=2.8.2",
    "tqdm>=4.65.0",
    "tomli>=2.0.0; python_version < '3.11'",
]

[dependency-groups]
dev = [
    "pytest>=8.4.0",
    "pytest-asyncio>=0.23.0",
    "pytest-mock>=3.14.0",
    "pytest-cov>=6.0.0",
    "pytest-timeout>=2.3.0",
    "pytest-xdist>=3.6.0",
    "ruff>=0.6.0",
    "pip-audit>=2.7.0",
    "mypy>=1.13.0",
    "pandas-stubs>=2.0.0",
    "poethepoet>=0.38.0",
    "pre-commit>=4.5.0",
    # Security
    "bandit>=1.7.0",
    "httpx>=0.24.0",
    "respx>=0.20.0",
    "types-aiofiles>=25.1.0.20251011",
    "types-requests>=2.32.4.20250913",
]

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
asyncio_mode = "strict"
addopts = [
    "-v",
    "--strict-markers",
    "--strict-config",
    "--tb=short",
    "--ignore=nook/frontend",
    "--ignore=node_modules",
    "-ra",
    "-n=auto",
]
markers = [
    "unit: ユニットテスト（外部依存をモック化）",
    "integration: 統合テスト（外部API使用、CIでスキップ可）",
    "slow: 実行に時間のかかるテスト",
    "performance: パフォーマンステスト",
    "memory: メモリテスト",
    "stress: ストレステスト",
    "security: セキュリティテスト（脆弱性・攻撃耐性検証）",
]
filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::PendingDeprecationWarning",
]

[tool.ruff]
line-length = 100
indent-width = 4
target-version = "py310"

[tool.ruff.lint]
exclude = [".venv"]
select = [
    "E",     # pycodestyle errors
    "W",     # pycodestyle warnings
    "F",     # pyflakes
    "I",     # isort
    "N",     # pep8-naming
    "D",     # pydocstyle
    "B",     # flake8-bugbear
    "C4",    # flake8-comprehensions
    "UP",    # pyupgrade
    "S",     # flake8-bandit (セキュリティチェック)
    "ARG",   # flake8-unused-arguments
    "PTH",   # flake8-use-pathlib
    "SIM",   # flake8-simplify
    "RET",   # flake8-return
    "TRY",   # tryceratops
    "ASYNC", # flake8-async
    "RUF",   # Ruff固有のルール
    "PD",    # pandas-vet
    "G",
    "EXE",
    # Not included in flake8
    "LOG",
    "NPY",
    "PERF",
    "PGH004",
    "PIE794",
    "PIE800",
    "PIE804",
    "PIE807",
    "PIE810",
    "PLC0131", # type bivariance
    "PLC0132", # type param mismatch
    "PLC0205", # string as __slots__
    "PLE",
    "PLR0133", # constant comparison
    "PLR0206", # property with params
    "PLR1722", # use sys exit
    "PLW0129", # assert on string literal
    "PLW0406", # import self
    "PLW0711", # binary op exception
    "PLW1509", # preexec_fn not safe with threads
    "PLW3301", # nested min max
    "PT006", # TODO: enable more PT rules
    "PT022",
    "PT023",
    "PT024",
    "PT025",
    "PT026",
    "PYI",
    "B904",    # raise from (TRY200の新名称)
    "TRY203",  # raise within try (TRY302の新名称)
]
ignore = [
    "E501", # line too long (handled by ruff format)
    "G004", # logging statement uses f-string (project style choice)
    "G003", # logging statement uses + (acceptable for formatting)
    "G201", # logging .exception() vs .error(exc_info=True) (both are acceptable)
    "PERF203", # try-except within a loop (intentional for error handling)
    "PERF401", # list comprehension vs append (readability preference)
    "PERF402", # list vs list.copy (minor performance difference)
    "PERF403", # dict comprehension (readability preference)
    "SIM102", # nested if statements (sometimes clearer)
    "SIM108", # ternary operator (readability preference)
    "SIM118", # key in dict vs key in dict.keys() (explicit is sometimes clearer)
    # Docstring rules (日本語docstring対応 & 既存コードスタイル)
    "D100",  # Missing docstring in public module
    "D102",  # Missing docstring in public method
    "D103",  # Missing docstring in public function
    "D104",  # Missing docstring in public package
    "D107",  # Missing docstring in __init__
    "D205",  # 1 blank line required between summary line and description
    "D400",  # First line should end with a period
    "D401",  # First line should be in imperative mood
    "D415",  # First line should end with punctuation
    "D417",  # Missing argument descriptions in docstring
    # Exception handling (既存のエラーハンドリングパターン)
    "TRY003", # Avoid specifying long messages outside exception class
    "TRY201", # Use raise without specifying exception name
    "TRY300", # Consider moving statement to else block
    "TRY301", # Abstract raise to inner function
    "TRY400", # Use logging.exception instead of logging.error
    # Return statements
    "RET504", # Unnecessary assignment before return
    # Simplification
    "SIM211", # Use not ... instead of False if ... else True
    # Type annotations
    "RUF012", # Mutable class attributes should use ClassVar
    "RUF013", # PEP 484 prohibits implicit Optional
    # Naming
    "N818",  # Exception name should end with Error suffix
    # Security (intentional patterns)
    "S104",  # Possible binding to all interfaces (dev server)
    "S110",  # try-except-pass (intentional in some cases)
    "S311",  # Standard pseudo-random generators (non-cryptographic use)
    # Async
    "ASYNC210", # Async functions calling blocking methods (intentional)
    "ASYNC230", # Async functions opening files with blocking methods
    # Pathlib (既存コードとの互換性)
    "PTH100", # os.path.abspath should use Path.resolve
    "PTH103", # os.makedirs should use Path.mkdir
    "PTH110", # os.path.exists should use Path.exists
    "PTH118", # os.path.join should use Path with / operator
    "PTH120", # os.path.dirname should use Path.parent
    "PTH123", # open() should use Path.open
    # General
    "EXE001", # Shebang present but file not executable
    # 全角記号
    "RUF001", # 全角記号(コメント)
    "RUF003", # 全角記号(コメント)
    "D203",  # 1 blank line required before class docstring (conflicts with D211)
    "D213",  # Multi-line docstring summary should start at the second line (conflicts with D212)
    "RUF002", # Docstring contains ambiguous unicode character (Japanese text)
]

[tool.ruff.lint.per-file-ignores]
"tests/**/*.py" = [
    "E501",  # Line too long in test files (test data often exceeds limit)
    "E402",  # Module level import not at top of file (tests need sys.path setup)
    "E721",  # Type comparison with == (acceptable in tests)
    "B017",  # Blind exception assertions (acceptable in tests)
    "S101",  # Use of assert (required in tests)
    "S105",  # Possible hardcoded password (test credentials)
    "S106",  # Possible hardcoded password argument (test credentials)
    "S108",  # Insecure temp file usage (acceptable in tests)
    "D100",  # Missing docstring in public module
    "D101",  # Missing docstring in public class
    "D102",  # Missing docstring in public method
    "D103",  # Missing docstring in public function
    "D104",  # Missing docstring in public package
    "D205",  # 1 blank line required between summary line and description
    "D400",  # First line should end with a period
    "D415",  # First line should end with punctuation
    "ARG001", # Unused function argument (fixtures)
    "ARG002", # Unused method argument
    "ARG005", # Unused lambda argument
    "PTH",   # flake8-use-pathlib (tests often use os.path)
    "TRY",   # tryceratops (test exception handling differs)
    "ASYNC", # flake8-async (test async patterns differ)
    "PD",    # pandas-vet (test data patterns differ)
    "RUF059", # Unpacked variable never used (intentional in tests)
    "RET505", # Unnecessary elif after return (Copilot recommends elif for readability)
]
"tests/conftest.py" = [
    "E501",  # Line too long (HTML/test data strings)
    "E402",  # Module level import not at top of file
]
"nook/services/run_services*.py" = [
    "E402",  # Module level import not at top of file (needs sys.path setup)
    "ARG001", # Unused function argument (signal handler)
]
"**/debug_auth.py" = [
    "D100",  # Missing docstring in public module
    "EXE001", # Shebang present but file not executable
]
"nook/services/**/" = [
    "ARG002", # Unused method argument (storage_dir, entry)
]
"nook/common/**/*.py" = [
    "ARG002", # Unused method argument (service_name, kwargs)
]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "auto"

[tool.coverage.run]
source = ["nook"]
omit = [
    "*/tests/*",
    "*/__init__.py",
]

[tool.coverage.report]
precision = 2
show_missing = true
skip_covered = false
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "\\.\\.\\.",
    "pass",
    'logger\.info\(',
    'logger\.debug\(',
    'logger\.warning\(',
    'self\.logger\.info\(',
    'self\.logger\.debug\(',
]

[tool.mypy]
python_version = "3.10"
warn_return_any = false
warn_unused_configs = true
warn_redundant_casts = true
warn_unused_ignores = true
strict_equality = true
no_implicit_optional = true

# 既存コードへの影響を最小化（緩い設定）
disallow_untyped_defs = false
disallow_any_generics = false
disallow_subclassing_any = false
disallow_untyped_calls = false
disallow_incomplete_defs = false
check_untyped_defs = false

# サードパーティライブラリの型スタブが無い場合は無視
ignore_missing_imports = true

# 除外するディレクトリ
exclude = [
    "^tests/",
    "^build/",
    "^.venv/",
    "^nook/frontend/",
    "^task.*-.*-test/",
]

[tool.poe.tasks]
format = "uv run ruff format ."
lint = "uv run ruff check --fix ."
type-check = "uv run mypy ."
test = "uv run pytest -n auto tests/ -v"
coverage = "uv run pytest -n auto --cov=nook --cov-report=term"
audit = "uv run pip-audit --ignore-vuln GHSA-f83h-ghpp-7wcc"

check = ["format", "lint", "type-check"]
quality-check = ["check", "test", "coverage", "audit"]
