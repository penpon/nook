name: JS Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/js-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/js-tests.yml'
  workflow_dispatch:  # 手動実行を許可

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  quality-check:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref || github.ref_name }}  # PRブランチまたは現在のブランチ

    - name: Workflow Telemetry
      uses: catchpoint/workflow-telemetry-action@v2.0.0
      with:
        comment_on_pr: false
        proc_trace_sys_enable: true

    - name: Node.js のセットアップ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: 依存関係のインストール
      run: npm ci

    - name: 品質チェック実行
      run: |
        set -e
        echo "=== 品質チェックを実行中 (lint, format, type-check) ==="
        npm run quality-check
        echo ""
        echo "✅ すべての品質チェックが成功しました"

    - name: テスト結果サマリーの生成
      if: always()
      run: |
        test_status="${{ job.status }}"

        {
          echo "## JS 品質チェック結果サマリー"
          echo ""
          echo "### ジョブ状態"
          if [ "$test_status" = "success" ]; then
            echo "✅ すべての品質チェックが成功しました"
          else
            echo "❌ 品質チェックが失敗しました"
          fi
          echo ""
          echo "### チェック内容"
          echo "- Lint: ESLint"
          echo "- Format: Prettier"
          echo "- Type Check: TypeScript"
          echo ""
          echo "### テスト環境"
          echo "- Node.js バージョン: 20"
          echo "- ブランチ: ${{ github.ref_name }}"
        } >> "$GITHUB_STEP_SUMMARY"
