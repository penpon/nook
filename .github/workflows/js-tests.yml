name: JS Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/js-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/js-tests.yml'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

permissions:
  contents: write  # è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆæ™‚ã®ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦

jobs:
  quality-check:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref || github.ref_name }}  # PRãƒ–ãƒ©ãƒ³ãƒã¾ãŸã¯ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ

    - name: Node.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci

    - name: å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
      run: |
        set -e
        echo "=== å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­ (lint, format, type-check) ==="
        npm run quality-check
        echo ""
        echo "âœ… ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"

    - name: ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ›´ã®è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
      if: github.event_name == 'pull_request'
      working-directory: .
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        if ! git diff --quiet -- frontend/; then
          echo "ðŸ“ ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™..."
          git add frontend/
          git commit -m "style: Prettier/ESLintã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆé©ç”¨" -m "ðŸ¤– è‡ªå‹•ä¿®æ­£by GitHub Actions"
          git push
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        else
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi

    - name: ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼ã®ç”Ÿæˆ
      if: always()
      run: |
        test_status="${{ job.status }}"

        {
          echo "## JS å“è³ªãƒã‚§ãƒƒã‚¯çµæžœã‚µãƒžãƒªãƒ¼"
          echo ""
          echo "### ã‚¸ãƒ§ãƒ–çŠ¶æ…‹"
          if [ "$test_status" = "success" ]; then
            echo "âœ… ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "âŒ å“è³ªãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          fi
          echo ""
          echo "### ãƒã‚§ãƒƒã‚¯å†…å®¹"
          echo "- Lint: ESLint"
          echo "- Format: Prettier"
          echo "- Type Check: TypeScript"
          echo ""
          echo "### ãƒ†ã‚¹ãƒˆç’°å¢ƒ"
          echo "- Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 20"
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        } >> "$GITHUB_STEP_SUMMARY"
