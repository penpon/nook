name: Claude Auto-fix Test Failures

on:
  workflow_run:
    workflows: ["Tests"]
    types:
      - completed

jobs:
  auto-fix-tests:
    # テストワークフローが失敗し、かつPRからのトリガーの場合のみ実行
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'

    runs-on: ubuntu-slim
    permissions:
      contents: write
      pull-requests: write
      actions: read
      checks: read
      id-token: write

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = github.event.workflow_run.pull_requests[0]?.number;
            if (!prNumber) {
              core.setFailed('PR番号を取得できませんでした');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            core.setOutput('pr_number', prNumber);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download test logs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runId = github.event.workflow_run.id;

            // ジョブログを取得
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            let failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            // 失敗したジョブの情報をファイルに保存
            const jobInfo = failedJobs.map(job => ({
              name: job.name,
              conclusion: job.conclusion,
              html_url: job.html_url
            }));

            fs.writeFileSync('failed_jobs.json', JSON.stringify(jobInfo, null, 2));

      - name: Run Claude Code to fix test failures
        id: claude-fix
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr.outputs.pr_number }}
            WORKFLOW RUN: ${{ github.event.workflow_run.html_url }}

            テストワークフローが失敗しました。

            失敗したジョブ情報:
            $(cat failed_jobs.json)

            以下の手順で対応してください:

            1. `gh run view ${{ github.event.workflow_run.id }} --log-failed`で失敗したテストのログを確認
            2. エラーメッセージを分析し、根本原因を特定
            3. 失敗したテストを修正:
               - テストコード自体の問題（test_*.py）
               - 実装コードの問題（modules/）
               - 依存関係の問題（pyproject.toml）
            4. CLAUDE.mdの規約に従って修正
            5. ローカルでテストを実行して確認（可能であれば）
            6. 修正内容をコミット（メッセージ: "fix: テスト失敗を修正 - [失敗したテスト名]"）
            7. プッシュ

            注意事項:
            - カバレッジ要求（80%以上）も考慮すること
            - セキュリティチェック（bandit, pip-audit）の警告も対処すること
            - 修正は最小限に留め、テストが通ることを最優先すること

          claude_args: '--allowed-tools "Bash(gh run:*),Bash(gh pr:*),Bash(git:*),Bash(uv:*),Bash(pytest:*)"'
