name: Python Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/python-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.py'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.github/workflows/python-tests.yml'
  workflow_dispatch:  # 手動実行を許可

permissions:
  contents: read

jobs:
  quality-check:
    runs-on: ubuntu-latest

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref || github.ref_name }}  # PRブランチまたは現在のブランチ

    - name: uv のセットアップ
      uses: astral-sh/setup-uv@v3.0.0

    - name: キャッシュの復元
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: 依存関係のインストール
      run: |
        uv sync --group dev

    - name: 品質チェック実行 (poe ci-check)
      run: |
        set -e
        echo "=== 品質チェックを実行中 (format-check, lint-check, test, coverage, audit) ==="
        uv run poe ci-check
        echo ""
        echo "✅ すべての品質チェックが成功しました"

    - name: テスト結果サマリーの生成
      if: always()
      run: |
        test_status="${{ job.status }}"

        {
          echo "## 品質チェック結果サマリー"
          echo ""
          echo "### ジョブ状態"
          if [ "$test_status" = "success" ]; then
            echo "✅ すべての品質チェックが成功しました"
          else
            echo "❌ 品質チェックが失敗しました"
          fi
          echo ""
          echo "### チェック内容"
          echo "- Format: Ruff フォーマット"
          echo "- Lint: Ruff リント"
          echo "- Test: pytest ユニットテスト"
          echo "- Coverage: カバレッジ測定"
          echo "- Audit: pip-audit"
          echo ""
          echo "### テスト環境"
          echo "- Python バージョン: 3.12"
          echo "- ブランチ: ${{ github.ref_name }}"
          echo ""
          if [ -f coverage.xml ] && [ "$test_status" = "success" ]; then
            echo "### カバレッジ率"
            echo "\`\`\`"
            uv run pytest --cov=nook --cov-report=term
            echo "\`\`\`"
          elif [ ! -f coverage.xml ]; then
            echo "⚠️ カバレッジレポート（coverage.xml）が見つかりません"
          fi
        } >> "$GITHUB_STEP_SUMMARY"
