name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # 手動実行を許可

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-slim

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4.1.0

    - name: uv のセットアップ
      uses: astral-sh/setup-uv@v3.0.0

    - name: キャッシュの復元
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-test-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-test-

    - name: 依存関係のインストール
      run: |
        uv sync --extra dev

    - name: ユニットテストの実行とカバレッジ確認
      run: |
        set -e
        echo "=== ユニットテストを実行中 ==="
        uv run pytest tests/ -v --cov=modules --cov-report=xml --cov-report=term-missing --timeout=300 --tb=short
        echo ""
        echo "=== カバレッジ率を確認中 ==="
        uv run coverage report --format=text

    - name: テスト結果サマリーの生成
      if: always()
      run: |
        test_status="${{ job.status }}"

        {
          echo "## テスト結果サマリー"
          echo ""
          echo "### ジョブ状態"
          if [ "$test_status" = "success" ]; then
            echo "✅ すべてのテストとカバレッジチェックが成功しました"
          else
            echo "❌ テストまたはカバレッジチェックが失敗しました"
          fi
          echo ""
          echo "### テスト環境"
          echo "- Python バージョン: 3.12"
          echo "- ブランチ: ${{ github.ref_name }}"
          echo ""
          if [ -f coverage.xml ] && [ "$test_status" = "success" ]; then
            echo "### カバレッジ率"
            echo "\`\`\`"
            uv run coverage report --format=text
            echo "\`\`\`"
          elif [ ! -f coverage.xml ]; then
            echo "⚠️ カバレッジレポート（coverage.xml）が見つかりません"
          fi
        } >> $GITHUB_STEP_SUMMARY

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4.1.0

    - name: uv のセットアップ
      uses: astral-sh/setup-uv@v3.0.0

    - name: キャッシュの復元
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-lint-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-lint-

    - name: 依存関係のインストール
      run: |
        uv sync --extra dev

    - name: 静的解析とフォーマットチェック
      run: |
        set -e
        echo "=== Black (コードフォーマットチェック) ==="
        uv run black --check modules/ tests/
        echo ""
        echo "=== Ruff (リント・インポート順序チェック) ==="
        uv run ruff check modules/ tests/
        echo ""
        echo "=== Ruff フォーマッター (チェック) ==="
        uv run ruff format --check modules/ tests/
        echo ""
        echo "✅ すべての静的解析とフォーマットチェックが成功しました"

  security:
    runs-on: ubuntu-latest

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4.1.0

    - name: uv のセットアップ
      uses: astral-sh/setup-uv@v3.0.0

    - name: キャッシュの復元
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-security-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-security-

    - name: 依存関係のインストール
      run: |
        uv sync --extra dev

    - name: セキュリティツールのインストール
      run: |
        uv pip install bandit pip-audit

    - name: セキュリティチェック (bandit)
      run: |
        echo "=== コード脆弱性をスキャン中 (bandit) ==="
        set +e
        uv run bandit -r modules/ tests/ -ll -f txt
        bandit_exit=$?
        set -e

        if [ $bandit_exit -ne 0 ]; then
          echo "❌ bandit で脆弱性が検出されました（終了コード: $bandit_exit）"
          exit 1
        fi
        echo "✅ bandit スキャン完了（脆弱性なし）"

    - name: 依存関係の脆弱性チェック (pip-audit)
      run: |
        echo "=== 依存パッケージの脆弱性をチェック中 (pip-audit) ==="
        set +e
        timeout 60 uv run pip-audit
        exit_code=$?
        set -e

        if [ $exit_code -eq 124 ]; then
          echo "❌ pip-audit がタイムアウト（60秒）"
          exit 1
        elif [ $exit_code -ne 0 ]; then
          echo "❌ pip-audit で脆弱性が検出されました（終了コード: $exit_code）"
          exit 1
        fi
        echo "✅ pip-audit チェック完了（脆弱性なし）"
