name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

permissions:
  contents: write  # è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ™‚ã®ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦

jobs:
  unit-test:
    runs-on: ubuntu-latest

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4.1.0

    - name: uv ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: astral-sh/setup-uv@v3.0.0

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-test-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-test-

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: uv sync --all-groups

    - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ä¸¦åˆ—å®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
      run: |
        set -e
        echo "=== ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œä¸­ï¼ˆpytest-xdistä½¿ç”¨ï¼‰ ==="
        echo "æ³¨: çµ±åˆãƒ†ã‚¹ãƒˆãƒ»æ€§èƒ½ãƒ†ã‚¹ãƒˆã¯åˆ¥ã‚¸ãƒ§ãƒ–ã§å®Ÿè¡Œã•ã‚Œã¾ã™"
        uv run pytest tests/services/arxiv_summarizer/ -n auto -m "not integration and not performance and not memory and not stress" --cov=nook/services/arxiv_summarizer --cov-report=xml --cov-report=term-missing --timeout=300 --tb=short
        echo ""
        echo "=== ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡ã‚’ç¢ºèªä¸­ ==="
        uv run coverage report --format=text

    - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
      if: always()
      run: |
        test_status="${{ job.status }}"

        {
          echo "## ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼"
          echo ""
          echo "### ã‚¸ãƒ§ãƒ–çŠ¶æ…‹"
          if [ "$test_status" = "success" ]; then
            echo "âœ… ã™ã¹ã¦ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "âŒ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¾ãŸã¯ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          fi
          echo ""
          echo "### ãƒ†ã‚¹ãƒˆç’°å¢ƒ"
          echo "- Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 3.12"
          echo "- ä¸¦åˆ—å®Ÿè¡Œ: pytest-xdist (-n auto)"
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo ""
          if [ -f coverage.xml ] && [ "$test_status" = "success" ]; then
            echo "### ã‚«ãƒãƒ¬ãƒƒã‚¸ç‡"
            echo "\`\`\`"
            uv run coverage report --format=text
            echo "\`\`\`"
          elif [ ! -f coverage.xml ]; then
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆï¼ˆcoverage.xmlï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
        } >> "$GITHUB_STEP_SUMMARY"

  integration-test:
    runs-on: ubuntu-latest

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4.1.0

    - name: uv ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: astral-sh/setup-uv@v3.0.0

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-integration-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-integration-

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: uv sync --all-groups

    - name: çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      run: |
        set -e
        echo "=== çµ±åˆãƒ†ã‚¹ãƒˆã‚’é †æ¬¡å®Ÿè¡Œä¸­ ==="
        uv run pytest tests/services/arxiv_summarizer/ -v -m "integration" --timeout=600 --tb=short -p no:cov || [ $? -eq 5 ]

    - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
      if: always()
      run: |
        test_status="${{ job.status }}"

        {
          echo "## çµ±åˆãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼"
          echo ""
          echo "### ã‚¸ãƒ§ãƒ–çŠ¶æ…‹"
          if [ "$test_status" = "success" ]; then
            echo "âœ… ã™ã¹ã¦ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "âŒ çµ±åˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          fi
          echo ""
          echo "### ãƒ†ã‚¹ãƒˆç’°å¢ƒ"
          echo "- Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 3.12"
          echo "- å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: é †æ¬¡å®Ÿè¡Œï¼ˆå¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ã®ãŸã‚ï¼‰"
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        } >> "$GITHUB_STEP_SUMMARY"

  performance-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4.1.0

    - name: uv ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: astral-sh/setup-uv@v3.0.0

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-performance-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-performance-

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: uv sync --all-groups

    - name: æ€§èƒ½ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      run: |
        set -e
        echo "=== æ€§èƒ½ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­ ==="
        echo "æ³¨: ã“ã®ãƒ†ã‚¹ãƒˆã¯æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã™"
        uv run pytest tests/services/arxiv_summarizer/ -v -m "performance or memory or stress" --timeout=900 --tb=short -s -p no:cov || [ $? -eq 5 ]

    - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
      if: always()
      run: |
        test_status="${{ job.status }}"

        {
          echo "## æ€§èƒ½ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼"
          echo ""
          echo "### ã‚¸ãƒ§ãƒ–çŠ¶æ…‹"
          if [ "$test_status" = "success" ]; then
            echo "âœ… ã™ã¹ã¦ã®æ€§èƒ½ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "âŒ æ€§èƒ½ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          fi
          echo ""
          echo "### ãƒ†ã‚¹ãƒˆç’°å¢ƒ"
          echo "- Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 3.12"
          echo "- å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: é †æ¬¡å®Ÿè¡Œ"
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo ""
          echo "### ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª"
          echo "- performance: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãƒ»ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ"
          echo "- memory: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡"
          echo "- stress: ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ"
        } >> "$GITHUB_STEP_SUMMARY"

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref || github.ref_name }}  # PRãƒ–ãƒ©ãƒ³ãƒã¾ãŸã¯ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ

    - name: uv ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: astral-sh/setup-uv@v3.0.0

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-lint-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-lint-

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: uv sync --all-groups

    - name: é™çš„è§£æã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      run: |
        set -e
        echo "=== Black (ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ) ==="
        uv run black nook/ tests/
        echo ""
        echo "=== Ruff (ãƒªãƒ³ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºãƒã‚§ãƒƒã‚¯) ==="
        uv run ruff check nook/ tests/ --fix
        echo ""
        echo "=== Ruff ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ ==="
        uv run ruff format nook/ tests/
        echo ""
        echo "âœ… ã™ã¹ã¦ã®é™çš„è§£æã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"

    - name: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´ã®è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
      if: github.event_name == 'pull_request'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        if ! git diff --quiet nook/ tests/; then
          echo "ğŸ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™..."
          git add nook/ tests/
          git commit -m "style: Blackã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé©ç”¨" -m "ğŸ¤– è‡ªå‹•ä¿®æ­£by GitHub Actions"
          git push
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        else
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi

  security:
    runs-on: ubuntu-latest

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4.1.0

    - name: uv ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: astral-sh/setup-uv@v3.0.0

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-security-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-security-

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: uv sync --all-groups

    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (bandit)
      run: |
        echo "=== ã‚³ãƒ¼ãƒ‰è„†å¼±æ€§ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­ (bandit) ==="
        set +e
        uv run bandit -r nook/ tests/services/arxiv_summarizer/ tests/conftest.py -ll -f txt
        bandit_exit=$?
        set -e

        if [ $bandit_exit -ne 0 ]; then
          echo "âŒ bandit ã§è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $bandit_exitï¼‰"
          exit 1
        fi
        echo "âœ… bandit ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†ï¼ˆè„†å¼±æ€§ãªã—ï¼‰"

    - name: ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ (pip-audit)
      run: |
        echo "=== ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­ (pip-audit) ==="
        set +e
        timeout 60 uv run pip-audit
        exit_code=$?
        set -e

        if [ $exit_code -eq 124 ]; then
          echo "âŒ pip-audit ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ60ç§’ï¼‰"
          exit 1
        elif [ $exit_code -ne 0 ]; then
          echo "âŒ pip-audit ã§è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $exit_codeï¼‰"
          exit 1
        fi
        echo "âœ… pip-audit ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ˆè„†å¼±æ€§ãªã—ï¼‰"
