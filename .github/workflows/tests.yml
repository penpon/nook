name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

permissions:
  contents: write  # è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆæ™‚ã®ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦

jobs:
  quality-check:
    runs-on: ubuntu-latest

    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref || github.ref_name }}  # PRãƒ–ãƒ©ãƒ³ãƒã¾ãŸã¯ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ

    - name: uv ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: astral-sh/setup-uv@v3.0.0

    - name: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: .venv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        uv sync --group dev

    - name: å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ (poe check)
      run: |
        set -e
        echo "=== å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­ (format, lint, test) ==="
        uv run poe format
        uv run poe lint
        uv run pytest tests/ -v --cov=nook --cov-report=xml --cov-report=term-missing --tb=short
        echo ""
        echo "âœ… ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"

    - name: ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ›´ã®è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ
      if: github.event_name == 'pull_request'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        if ! git diff --quiet -- nook/ tests/; then
          echo "ðŸ“ ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™..."
          git add nook/ tests/
          git commit -m "style: Ruffã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆé©ç”¨" -m "ðŸ¤– è‡ªå‹•ä¿®æ­£by GitHub Actions"
          git push
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        else
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
        fi

    - name: ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼ã®ç”Ÿæˆ
      if: always()
      run: |
        test_status="${{ job.status }}"

        {
          echo "## å“è³ªãƒã‚§ãƒƒã‚¯çµæžœã‚µãƒžãƒªãƒ¼"
          echo ""
          echo "### ã‚¸ãƒ§ãƒ–çŠ¶æ…‹"
          if [ "$test_status" = "success" ]; then
            echo "âœ… ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "âŒ å“è³ªãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          fi
          echo ""
          echo "### ãƒã‚§ãƒƒã‚¯å†…å®¹"
          echo "- Format: Ruff ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ"
          echo "- Lint: Ruff ãƒªãƒ³ãƒˆ"
          echo "- Type Check: mypy åž‹ãƒã‚§ãƒƒã‚¯"
          echo "- Test: pytest ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ"
          echo "- Coverage: ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š"
          echo ""
          echo "### ãƒ†ã‚¹ãƒˆç’°å¢ƒ"
          echo "- Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 3.12"
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo ""
          if [ -f coverage.xml ] && [ "$test_status" = "success" ]; then
            echo "### ã‚«ãƒãƒ¬ãƒƒã‚¸çŽ‡"
            echo "```"
            uv run pytest --cov=nook --cov-report=term
            echo "```"
          elif [ ! -f coverage.xml ]; then
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆï¼ˆcoverage.xmlï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
        } >> "$GITHUB_STEP_SUMMARY"
